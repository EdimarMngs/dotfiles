#!/bin/bash

set -e

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ FunÃ§Ãµes auxiliares                           â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

print_section() {
    echo ""
    echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
    echo "â”‚ $1"
    echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"
}

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ InÃ­cio e ValidaÃ§Ãµes de Sistema               â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
echo "ğŸš€ [+] Iniciando script de preparaÃ§Ã£o..."

if [[ -z "$GITHUB_USERNAME" ]]; then
    GITHUB_USERNAME="EdimarMngs"
fi

if ! command_exists apt; then
    echo "âŒ Erro: Gerenciador de pacotes 'apt' nÃ£o encontrado. Finalizando."
    exit 1
fi

if ! sudo -v 2>/dev/null; then
    echo "ğŸ” Este script requer privilÃ©gios de sudo. Solicitando acesso..."
    if ! sudo -v; then
        echo "âŒ Falha ao validar sudo. Finalizando."
        exit 1
    fi
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ AtualizaÃ§Ã£o do sistema                       â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Atualizando sistema"
touch "$HOME"/.hushlogin
sudo apt update && sudo apt upgrade -y
sudo apt install -y bash-completion
echo "âœ… Sistema atualizado"

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ InstalaÃ§Ã£o de Ferramentas (Nvim, Jq, Git)     â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
for pkg in neovim jq git; do
    print_section "Verificando $pkg"
    if command_exists "$pkg"; then
        echo "âœ… $pkg jÃ¡ estÃ¡ instalado"
    else
        echo "ğŸ“¦ Instalando $pkg..."
        sudo apt install -y "$pkg"
    fi
done

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Instalar Docker                              â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Verificando Docker"
if command_exists docker; then
    echo "âœ… Docker jÃ¡ estÃ¡ instalado"
else
    echo "ğŸ“¦ Instalando Docker..."
    for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do
        sudo apt remove -y $pkg || true
    done
    sudo apt install -y ca-certificates curl
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc
    # shellcheck source=/dev/null
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
    sudo apt update
    sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    sudo groupadd docker || true
    sudo usermod -aG docker "$USER"
    echo "âœ… Docker instalado"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Instalar Bitwarden CLI                       â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Verificando Bitwarden CLI"
BW_BIN=/usr/local/bin/bw
if command_exists bw; then
    echo "âœ… Bitwarden CLI jÃ¡ estÃ¡ instalado"
else
    echo "ğŸ“¦ Instalando Bitwarden CLI..."
    sudo mkdir -p /usr/local/bin
    BW_ZIP=$(mktemp)
    curl -fsSL "https://bitwarden.com/download/?app=cli&platform=linux" -o "$BW_ZIP"
    sudo unzip -j "$BW_ZIP" bw -d /usr/local/bin
    sudo chmod +x "$BW_BIN"
    rm "$BW_ZIP"
    [[ ":$PATH:" != *":/usr/local/bin/:"* ]] && echo "export PATH=/usr/local/bin/:\$PATH" >>"$HOME/.bashrc"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Acesso Bitwarden e SSH                       â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "ConfiguraÃ§Ã£o Bitwarden"

get_ssh_key() {
    local key_name="$1"
    local path="$HOME/.ssh/$key_name"
    local raw_item=""
    if [[ ! -f "$path" ]]; then
        raw_item=$("$BW_BIN" get item "$key_name" --session "$BW_SESSION" --raw)
        echo "$raw_item" | jq -r '.notes' > "$path"
        echo "$raw_item" | jq -r '.fields[0].value' > "$path.pub"
        chmod 600 "$path" && chmod 644 "$path.pub"
        eval "$(ssh-agent -s)" >/dev/null 2>&1
        ssh-add "$path"
    fi
}

BW_STATUS=$("$BW_BIN" status | jq -r '.status')
BW_SESSION=""

# SÃ³ tenta logar se houver credenciais ou se o terminal for interativo
if [[ "$BW_STATUS" == "unauthenticated" || "$BW_STATUS" == "locked" ]]; then
    if [[ -f "$HOME/.pswds/bw" || -n "$BW_PASSWORD" || -t 0 ]]; then
        echo "Desbloqueando Bitwarden..."
        BW_CMD=$([[ "$BW_STATUS" == "unauthenticated" ]] && echo "login" || echo "unlock")
        
        if [[ -f "$HOME/.pswds/bw" ]]; then
            BW_SESSION=$("$BW_BIN" "$BW_CMD" --raw --passwordfile "$HOME/.pswds/bw")
        elif [[ -n "$BW_PASSWORD" ]]; then
            BW_SESSION=$("$BW_BIN" "$BW_CMD" --raw --passwordenv BW_PASSWORD)
        else
            BW_SESSION=$("$BW_BIN" "$BW_CMD" --raw)
        fi
    fi
fi

if [[ -n "$BW_SESSION" ]]; then
    export BW_SESSION
    "$BW_BIN" sync
    mkdir -p "$HOME"/.ssh && chmod 700 "$HOME"/.ssh
    
    echo "Buscando chaves SSH..."
    for key in acesso_build_vm acesso_demo_vm acesso_gitlab acesso_mngs_vm; do
        get_ssh_key "$key"
    done

    git config --global user.name "$GITHUB_USERNAME"
    git config --global user.email "$("$BW_BIN" get username "bee46207-f406-435f-8035-b3b0012258c1" --session "$BW_SESSION")"
    git config --global core.sshCommand "ssh -i ~/.ssh/ssh_github -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
    echo "âœ… ConfiguraÃ§Ãµes Bitwarden/SSH concluÃ­das"
else
    echo "âš ï¸  Bitwarden nÃ£o disponÃ­vel. Iniciando configuraÃ§Ã£o manual do Git:"
    read -rp "ğŸ‘¤ Username do Git [$GITHUB_USERNAME]: " manual_user
    git config --global user.name "${manual_user:-$GITHUB_USERNAME}"

    read -rp "ğŸ“§ Email do Git: " manual_email
    [[ -n "$manual_email" ]] && git config --global user.email "$manual_email"

    read -rp "ğŸ”‘ Path do arquivo SSH (ex: ~/.ssh/id_rsa): " manual_ssh
    if [[ -f "${manual_ssh/#\~/$HOME}" ]]; then
        git config --global core.sshCommand "ssh -i ${manual_ssh/#\~/$HOME} -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
        echo "âœ… SSH Path configurado."
    fi
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ FinalizaÃ§Ã£o                                  â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Finalizando"
chmod +x "$HOME"/scripts/personal_functions/* 2>/dev/null || true
echo "ğŸ Script concluÃ­do com sucesso."